# GPS
type gpsd, domain;
type gpsd_exec, exec_type, vendor_file_type, file_type;

init_daemon_domain(gpsd)

# IMS / VoLTE
# Note: Monitor 'avc: denied' logs for these domains if IMS fails to register.
# Common denials often involve 'connectto' permissions for ims service.

# IMS daemon domain for VoLTE/VT service registration
type imsd, domain;
type imsd_exec, exec_type, vendor_file_type, file_type;

init_daemon_domain(imsd)
allow imsd hwbinder_device:chr_file rw_file_perms;
allow imsd hwservicemanager:binder { call transfer };
allow imsd vndbinder_device:chr_file rw_file_perms;
allow imsd servicemanager:binder { call transfer };
allow imsd rild:unix_stream_socket connectto;
allow imsd radio_data_file:dir { search read open };
allow imsd radio_data_file:file { read open getattr };
allow imsd efs_file:dir { search read };
allow imsd efs_file:file { read open getattr };
allow imsd self:capability { net_admin net_raw };

# Binder access for Android 12 HALs
allow gpsd hwbinder_device:chr_file rw_file_perms;
allow gpsd hwservicemanager:binder { call transfer };

# Camera HAL
type camera_vendor, domain;
type camera_vendor_exec, exec_type, vendor_file_type, file_type;

init_daemon_domain(camera_vendor)
allow camera_vendor hwbinder_device:chr_file rw_file_perms;
allow camera_vendor hwservicemanager:binder { call transfer };
allow camera_vendor ion_device:chr_file rw_file_perms;

# Front flash LED sysfs access
type sysfs_front_flash, fs_type, sysfs_type;
allow camera_vendor sysfs_front_flash:dir search;
allow camera_vendor sysfs_front_flash:file rw_file_perms;
allow hal_camera_default sysfs_front_flash:dir search;
allow hal_camera_default sysfs_front_flash:file rw_file_perms;
allow system_server sysfs_front_flash:dir search;
allow system_server sysfs_front_flash:file rw_file_perms;

# Sensors HAL
type sensors_vendor, domain;
type sensors_vendor_exec, exec_type, vendor_file_type, file_type;

init_daemon_domain(sensors_vendor)
allow sensors_vendor hwbinder_device:chr_file rw_file_perms;
allow sensors_vendor hwservicemanager:binder { call transfer };
allow sensors_vendor sysfs:dir { open read search };
allow sensors_vendor sysfs:file { open read getattr };

# RIL daemon
allow rild hwbinder_device:chr_file rw_file_perms;
allow rild hwservicemanager:binder { call transfer };
allow rild vndbinder_device:chr_file rw_file_perms;
allow rild servicemanager:binder { call transfer };
allow rild efs_file:dir { search read open };
allow rild efs_file:file { read write open getattr };
allow rild radio_data_file:dir { create search read write open add_name remove_name };
allow rild radio_data_file:file { create read write open getattr setattr };
allow rild self:netlink_route_socket { create bind read write nlmsg_read };
allow rild self:udp_socket { create bind connect read write getopt setopt };

# Audio HAL
type audio_vendor, domain;
type audio_vendor_exec, exec_type, vendor_file_type, file_type;

init_daemon_domain(audio_vendor)
allow audio_vendor hwbinder_device:chr_file rw_file_perms;
allow audio_vendor hwservicemanager:binder { call transfer };

# Graphics / SurfaceFlinger
type graphics_vendor, domain;
type graphics_vendor_exec, exec_type, vendor_file_type, file_type;

init_daemon_domain(graphics_vendor)
allow graphics_vendor hwbinder_device:chr_file rw_file_perms;
allow graphics_vendor hwservicemanager:binder { call transfer };
allow graphics_vendor gpu_device:chr_file rw_file_perms;
allow graphics_vendor ion_device:chr_file rw_file_perms;

# Research / NetHunter tool domain
# Isolated domain for security research tools running in chroot/proot containers.
# Avoids global permissive mode by confining research tools to a dedicated domain.
type research_tool, domain;
type research_tool_exec, exec_type, file_type;

# Allow research tools to use network namespaces and raw sockets
allow research_tool self:capability { net_raw net_admin };
allow research_tool self:rawip_socket { create getopt setopt read write };
allow research_tool self:packet_socket { create bind getopt setopt read write };
allow research_tool self:netlink_route_socket { create bind getattr read write nlmsg_read nlmsg_write };
allow research_tool self:netlink_generic_socket { create bind read write };
allow research_tool self:udp_socket { create bind connect getopt setopt read write };
allow research_tool self:tcp_socket { create bind connect listen accept getopt setopt read write };

# Allow mount operations for chroot environments
# Note: mknod is required for populating /dev inside chroot containers
allow research_tool self:capability { sys_chroot sys_resource mknod };
allow research_tool tmpfs:filesystem mount;
allow research_tool proc:filesystem mount;
allow research_tool sysfs:filesystem mount;
allow research_tool devpts:filesystem mount;

# Allow loop device access for disk image mounting
allow research_tool loop_device:blk_file rw_file_perms;

# Allow access to /dev/tun for VPN operations
allow research_tool tun_device:chr_file rw_file_perms;

# USB HID gadget access for NetHunter
allow research_tool hidg_device:chr_file rw_file_perms;

# USB configfs access for NetHunter USB gadget management
allow research_tool configfs:dir { open read write search create add_name remove_name };
allow research_tool configfs:file { open read write create getattr setattr };
allow research_tool configfs:lnk_file { create read };

# Allow reading /proc and /sys for research tool enumeration
allow research_tool proc:file { read open getattr };
allow research_tool sysfs:file { read write open getattr };
allow research_tool sysfs:dir { read open search };

# Allow network interface management for wireless testing
allow research_tool self:netlink_kobject_uevent_socket { create bind read };
allow research_tool self:capability { net_bind_service };
