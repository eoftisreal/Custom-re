# Init script for Samsung Galaxy J7 (2016) — Android 12

import /vendor/etc/init/hw/init.exynos7870.rc
import /vendor/etc/init/hw/init.samsung.rc

on early-init
    # Debugfs: mount only if needed for boot, restrict to root only
    mount debugfs debugfs /sys/kernel/debug mode=0700,uid=0,gid=0

on init
    # Support legacy paths
    symlink /sdcard /storage/sdcard0

on fs
    mount_all /vendor/etc/fstab.exynos7870

on post-fs
    # ZRAM setup for 2GB RAM device -- 1.5GB (75% of RAM) for research workloads
    # Note: Must run after mount_all so /system/bin/mkswap is available
    write /sys/block/zram0/comp_algorithm lz4
    write /sys/block/zram0/max_comp_streams 4
    write /sys/block/zram0/disksize 1610612736
    exec u:r:init:s0 -- /system/bin/mkswap /dev/block/zram0
    exec u:r:init:s0 -- /system/bin/swapon /dev/block/zram0

    # Virtual memory tuning — balanced for stability and responsiveness
    write /proc/sys/vm/dirty_ratio 15
    write /proc/sys/vm/dirty_background_ratio 5
    write /proc/sys/vm/dirty_expire_centisecs 300
    write /proc/sys/vm/dirty_writeback_centisecs 500
    write /proc/sys/vm/vfs_cache_pressure 100
    write /proc/sys/vm/swappiness 60
    write /proc/sys/vm/overcommit_memory 1
    write /proc/sys/vm/min_free_kbytes 11520
    write /proc/sys/vm/extra_free_kbytes 24300
    write /proc/sys/vm/page-cluster 0

    # ASLR hardening — full randomization
    write /proc/sys/kernel/randomize_va_space 2

on post-fs-data
    # Create directory for EFS
    mkdir /efs 0771 radio system

    # Ensure vendor module directory exists for out-of-tree drivers
    mkdir /vendor/lib/modules 0755 root root

    # NetHunter chroot directories
    mkdir /data/local/nhsystem 0755 root root
    mkdir /data/local/nhsystem/kali-armhf 0755 root root

on boot
    # Permissions
    chown system system /sys/class/backlight/panel/brightness
    chmod 0660 /sys/class/backlight/panel/brightness

    # Front flash LED (Samsung front camera LED via sysfs)
    chown system camera /sys/class/leds/front_flash/brightness
    chmod 0664 /sys/class/leds/front_flash/brightness
    chown system camera /sys/class/leds/front_flash/max_brightness
    chmod 0444 /sys/class/leds/front_flash/max_brightness

    # CPU governor tuning (schedutil for Exynos 7870)
    write /sys/devices/system/cpu/cpufreq/policy0/scaling_governor schedutil
    write /sys/devices/system/cpu/cpufreq/policy0/schedutil/up_rate_limit_us 1000
    write /sys/devices/system/cpu/cpufreq/policy0/schedutil/down_rate_limit_us 20000

    # Kernel scheduler tuning — balanced latency and thermal stability
    write /proc/sys/kernel/sched_latency_ns 15000000
    write /proc/sys/kernel/sched_min_granularity_ns 2000000
    write /proc/sys/kernel/sched_wakeup_granularity_ns 3000000
    write /proc/sys/kernel/sched_migration_cost_ns 500000
    write /proc/sys/kernel/sched_child_runs_first 0
    write /proc/sys/kernel/sched_tunable_scaling 0

    # I/O scheduler optimization — balanced throughput for eMMC
    write /sys/block/mmcblk0/queue/scheduler cfq
    write /sys/block/mmcblk0/queue/read_ahead_kb 2048
    write /sys/block/mmcblk0/queue/nr_requests 128
    write /sys/block/mmcblk0/queue/iostats 0
    write /sys/block/mmcblk0/queue/add_random 0
    write /sys/block/mmcblk0/queue/rq_affinity 2
    write /sys/block/mmcblk0/queue/nomerges 0
    # Boot partition readahead
    write /sys/block/mmcblk0boot0/queue/read_ahead_kb 2048
    write /sys/block/mmcblk0boot1/queue/read_ahead_kb 2048

    # Entropy optimization — use urandom for faster boot
    write /proc/sys/kernel/random/read_wakeup_threshold 64
    write /proc/sys/kernel/random/write_wakeup_threshold 896

    # KSM (Kernel Same-page Merging) — deduplicate memory pages
    write /sys/kernel/mm/ksm/run 1
    write /sys/kernel/mm/ksm/sleep_millisecs 1000
    write /sys/kernel/mm/ksm/pages_to_scan 64

    # USB OTG stability — disable aggressive autosuspend
    write /sys/module/usbcore/parameters/autosuspend -1
    write /sys/bus/usb/devices/usb1/power/control on
    write /sys/bus/usb/devices/usb2/power/control on
    # Reduce USB kernel log spam to prevent resets from log congestion
    write /proc/sys/kernel/printk_ratelimit 5
    write /proc/sys/kernel/printk_ratelimit_burst 10

    # Network stack tuning for stability and research workloads
    write /proc/sys/net/core/rmem_max 8388608
    write /proc/sys/net/core/wmem_max 8388608
    write /proc/sys/net/core/rmem_default 1048576
    write /proc/sys/net/core/wmem_default 1048576
    write /proc/sys/net/core/netdev_max_backlog 5000
    write /proc/sys/net/core/netdev_budget 600
    write /proc/sys/net/core/somaxconn 1024
    write /proc/sys/net/ipv4/tcp_rmem "4096 1048576 8388608"
    write /proc/sys/net/ipv4/tcp_wmem "4096 1048576 8388608"
    write /proc/sys/net/ipv4/tcp_max_syn_backlog 4096
    write /proc/sys/net/ipv4/tcp_fin_timeout 15
    write /proc/sys/net/ipv4/tcp_keepalive_time 300
    write /proc/sys/net/ipv4/tcp_keepalive_probes 5
    write /proc/sys/net/ipv4/tcp_keepalive_intvl 15
    write /proc/sys/net/ipv4/tcp_max_orphans 16384
    write /proc/sys/net/ipv4/tcp_tw_reuse 1
    write /proc/sys/net/netfilter/nf_conntrack_max 65536
    write /proc/sys/net/netfilter/nf_conntrack_tcp_timeout_established 600
    write /proc/sys/net/ipv4/ip_local_port_range "1024 65535"

    # TCP optimization — kernel sysctl
    write /proc/sys/net/ipv4/tcp_congestion_control cubic
    write /proc/sys/net/ipv4/tcp_fastopen 3
    write /proc/sys/net/ipv4/tcp_ecn 0
    write /proc/sys/net/ipv4/tcp_timestamps 1
    write /proc/sys/net/ipv4/tcp_sack 1
    write /proc/sys/net/ipv4/tcp_window_scaling 1

    # Reduce excessive kernel logging for performance
    write /proc/sys/kernel/printk "4 4 1 4"

    # Load RTL8192EU USB WiFi driver module if present
    insmod /vendor/lib/modules/8192eu.ko

    # NetHunter: Ensure /dev/hidg0 HID gadget is accessible to research tools
    chown system system /dev/hidg0
    chmod 0660 /dev/hidg0

    # Thermal governor — reduce logging and tune for sustained workloads
    write /sys/class/thermal/thermal_zone0/mode enabled
    write /proc/sys/kernel/sched_boost 0

# Post-boot optimization — runs after boot animation completes
on property:sys.boot_completed=1
    # Drop page cache to reclaim memory after boot (dentries/inodes preserved)
    write /proc/sys/vm/drop_caches 1

    # Reduce readahead after boot for steady-state efficiency
    write /sys/block/mmcblk0/queue/read_ahead_kb 512
    write /sys/block/mmcblk0boot0/queue/read_ahead_kb 512
    write /sys/block/mmcblk0boot1/queue/read_ahead_kb 512

    # Set I/O scheduler to deadline for steady-state
    # CFQ provides fairness during boot (many concurrent processes); deadline provides
    # lower latency for steady-state single-user workloads and research tools.
    write /sys/block/mmcblk0/queue/scheduler deadline

    # Final thermal — slightly relax governor for sustained performance
    write /sys/devices/system/cpu/cpufreq/policy0/schedutil/down_rate_limit_us 10000

    # Unmount debugfs post-boot — not needed in production steady-state
    umount /sys/kernel/debug

service ril-daemon /vendor/bin/hw/rild
    class main
    user radio
    group radio cache inet misc audio log readproc wakelock net_admin net_raw
    capabilities BLOCK_SUSPEND NET_ADMIN NET_RAW
    socket rild stream 660 root radio
    socket rild-debug stream 660 radio system
    onrestart restart cpboot-daemon

# IMS daemon — starts after RIL for VoLTE/VT registration
service imsd /vendor/bin/imsd
    class main
    user radio
    group radio inet log
    disabled
    oneshot

on property:sys.rilconnected=1
    start imsd
