name: Build CoinOS for Samsung Galaxy J7 (j7xelte)

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Perform a clean build (make clean)'
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: Build CoinOS ROM
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      USE_CCACHE: "1"

    steps:
    - name: Maximize build space
      uses: easimon/maximize-build-space@v10
      with:
        root-reserve-mb: 12288
        swap-size-mb: 16384
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free root partition space
      run: |
        echo "=== Root partition before cleanup ==="
        df -h /
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        echo "=== Root partition after cleanup ==="
        df -h /

    - name: Install build dependencies
      run: |
        for attempt in 1 2 3; do
          echo "apt-get update attempt ${attempt}..."
          if sudo apt-get update; then
            break
          fi
          if [ "${attempt}" -eq 3 ]; then
            echo "ERROR: apt-get update failed after 3 attempts"
            exit 1
          fi
          echo "Retrying in 10 seconds..."
          sleep 10
        done
        sudo apt-get install -y --no-install-recommends \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib git \
          gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
          liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libwxgtk3.0-gtk3-dev \
          libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
          python3 python-is-python3 openjdk-11-jdk
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        mkdir -p ~/bin
        curl -fL --retry 3 https://storage.googleapis.com/git-repo-downloads/repo -o ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> "$GITHUB_PATH"

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action Build"
        git config --global user.email "action@github.com"
        git config --global color.ui false

    - name: Initialize repo and sync source
      run: |
        mkdir -p ~/workspace/coinos
        cd ~/workspace/coinos
        repo init -u https://github.com/eoftisreal/android.git -b coin-1.0 --depth=1

        # Create local manifests directory
        mkdir -p .repo/local_manifests

        # Add the device tree (this repository) to local manifests
        # Use a separate variable for GitHub expressions so heredoc quoting works
        REPO_NAME="${{ github.repository }}"
        REF_NAME="${{ github.ref_name }}"
        cat > .repo/local_manifests/j7xelte.xml << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <project path="device/samsung/j7xelte" name="${REPO_NAME}" remote="github" revision="${REF_NAME}" />
          <project path="kernel/samsung/exynos7870" name="android_kernel_samsung_exynos7870" remote="github" revision="coin-1.0" />
          <project path="vendor/samsung/j7xelte" name="android_vendor_samsung_j7xelte" remote="github" revision="coin-1.0" />
        </manifest>
        EOF

        # Verify the manifest is valid XML
        xmllint --noout .repo/local_manifests/j7xelte.xml || { echo "ERROR: Invalid local manifest XML"; cat .repo/local_manifests/j7xelte.xml; exit 1; }

        # Sync the source code with retry logic
        for attempt in 1 2 3; do
          echo "repo sync attempt ${attempt}..."
          if repo sync -c -j4 --force-sync --no-clone-bundle --no-tags; then
            echo "repo sync succeeded on attempt ${attempt}"
            break
          fi
          if [ "${attempt}" -eq 3 ]; then
            echo "ERROR: repo sync failed after 3 attempts"
            exit 1
          fi
          echo "repo sync failed, retrying in 15 seconds..."
          sleep 15
        done

    - name: Check disk space
      run: |
        echo "=== Disk space before build ==="
        df -h /
        df -h ~/workspace/coinos || true

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-coinos-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-coinos-ccache-

    - name: Build ROM
      shell: bash
      run: |
        cd ~/workspace/coinos

        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          make clean
        fi

        source build/envsetup.sh
        lunch coin_j7xelte-userdebug

        # Set ccache directory explicitly
        export CCACHE_DIR=~/.ccache
        ccache -M 50G
        ccache -z

        # Limit jobs based on available RAM (approx 2GB per job)
        MEM_GB=$(awk '/MemTotal/ {printf "%d", $2/1024/1024}' /proc/meminfo)
        MAX_JOBS=$((MEM_GB < 1 ? 1 : MEM_GB / 2))
        NPROC=$(nproc --all)
        JOBS=$((MAX_JOBS < NPROC ? MAX_JOBS : NPROC))
        echo "Building with -j${JOBS} (RAM: ${MEM_GB}GB, CPUs: ${NPROC})"

        # Start the build
        mka bacon -j${JOBS}

    - name: Print ccache stats
      if: always()
      run: ccache -s || true

    - name: Upload Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: CoinOS-j7xelte-ROM
        path: ~/workspace/coinos/out/target/product/j7xelte/CoinOS*.zip
        if-no-files-found: error
        retention-days: 7

    - name: Upload Build Logs on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ~/workspace/coinos/out/build_*.log
          ~/workspace/coinos/out/verbose.log.gz
          ~/workspace/coinos/out/error.log
        if-no-files-found: ignore
        retention-days: 7
