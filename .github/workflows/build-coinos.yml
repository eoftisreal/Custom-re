name: Build CoinOS for Samsung Galaxy J7 (j7xelte)

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Perform a clean build (make clean)'
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: Build CoinOS ROM
    runs-on: ubuntu-22.04
    timeout-minutes: 300
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      USE_CCACHE: "1"

    steps:
    - name: Maximize build space
      uses: easimon/maximize-build-space@v10
      with:
        root-reserve-mb: 4096
        swap-size-mb: 16384
        build-mount-path: /home/runner/workspace
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free root partition space
      run: |
        echo "=== Root partition before cleanup ==="
        df -h /
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /opt/hostedtoolcache
        sudo rm -rf /usr/share/swift
        sudo rm -rf /usr/share/miniconda
        sudo rm -rf /usr/share/az_*
        sudo rm -rf /usr/share/kotlinc
        sudo rm -rf /usr/share/gradle*
        sudo rm -rf /usr/share/sbt
        sudo rm -rf /usr/local/graalvm
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/lib/node_modules
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/pipx
        echo "=== Root partition after cleanup ==="
        df -h /
        echo "=== Build volume ==="
        df -h /home/runner/workspace

    - name: Install build dependencies
      run: |
        for attempt in 1 2 3; do
          echo "apt-get update attempt ${attempt}..."
          if sudo apt-get update; then
            break
          fi
          if [ "${attempt}" -eq 3 ]; then
            echo "ERROR: apt-get update failed after 3 attempts"
            exit 1
          fi
          echo "Retrying in 10 seconds..."
          sleep 10
        done
        sudo apt-get install -y --no-install-recommends \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib git \
          gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev \
          liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libwxgtk3.0-gtk3-dev \
          libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
          python3 python-is-python3 openjdk-11-jdk
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        mkdir -p ~/bin
        curl -fL --retry 3 https://storage.googleapis.com/git-repo-downloads/repo -o ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> "$GITHUB_PATH"

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Action Build"
        git config --global user.email "action@github.com"
        git config --global color.ui false

    - name: Initialize repo and sync source
      env:
        REPO_TRACE: "0"
      run: |
        WORKSPACE_DIR="/home/runner/workspace/coinos"
        mkdir -p "${WORKSPACE_DIR}"
        cd "${WORKSPACE_DIR}"

        echo "=== Disk space before repo init ==="
        df -h /home/runner/workspace

        repo init -u https://github.com/eoftisreal/android.git -b main --depth=1

        # Create local manifests directory
        mkdir -p .repo/local_manifests

        # Add the device tree (this repository) to local manifests
        REPO_NAME="${{ github.repository }}"
        REF_NAME="${{ github.ref_name }}"
        cat > .repo/local_manifests/j7xelte.xml << 'MANIFEST_EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <project path="device/samsung/j7xelte" name="REPO_NAME_PLACEHOLDER" remote="github" revision="REF_NAME_PLACEHOLDER" />
          <project path="kernel/samsung/exynos7870" name="android_kernel_samsung_exynos7870" remote="github" revision="main" />
          <project path="vendor/samsung/j7xelte" name="android_vendor_samsung_j7xelte" remote="github" revision="main" />
        </manifest>
        MANIFEST_EOF

        # Substitute placeholders with actual values
        sed -i "s|REPO_NAME_PLACEHOLDER|${REPO_NAME}|g" .repo/local_manifests/j7xelte.xml
        sed -i "s|REF_NAME_PLACEHOLDER|${REF_NAME}|g" .repo/local_manifests/j7xelte.xml

        # Verify the manifest is valid XML
        echo "=== Validating local manifest XML ==="
        cat .repo/local_manifests/j7xelte.xml
        xmllint --noout .repo/local_manifests/j7xelte.xml || {
          echo "ERROR: Invalid local manifest XML"
          exit 1
        }
        echo "Local manifest XML is valid."

        # Verify that linked repositories are accessible
        echo "=== Checking repository accessibility ==="
        for repo_url in \
          "https://github.com/${REPO_NAME}" \
          "https://github.com/eoftisreal/android_kernel_samsung_exynos7870" \
          "https://github.com/eoftisreal/android_vendor_samsung_j7xelte"; do
          if curl -fsSL --retry 2 -o /dev/null -w "%{http_code}" "${repo_url}" | grep -q "200"; then
            echo "  OK: ${repo_url}"
          else
            echo "  WARNING: ${repo_url} may not be accessible (non-200 status)"
          fi
        done

        # Sync the source code with retry logic and cleanup between attempts
        for attempt in 1 2 3; do
          echo "=== repo sync attempt ${attempt} of 3 ==="
          echo "Disk space before sync attempt:"
          df -h /home/runner/workspace

          # Check minimum disk space (need at least 10GB free)
          AVAIL_KB=$(df --output=avail /home/runner/workspace | tail -1)
          AVAIL_GB=$((AVAIL_KB / 1024 / 1024))
          echo "Available space: ${AVAIL_GB}GB"
          if [ "${AVAIL_GB}" -lt 10 ]; then
            echo "WARNING: Low disk space (${AVAIL_GB}GB available). Cleaning up..."
            # Remove repo trace and garbage files to reclaim space
            rm -f .repo/.repo_trace 2>/dev/null || true
            find .repo -name "*.lock" -delete 2>/dev/null || true
            repo forall -c 'git gc --prune=now' 2>/dev/null || true
            echo "Disk space after cleanup:"
            df -h /home/runner/workspace
          fi

          if repo sync -c -j2 --force-sync --no-clone-bundle --no-tags --optimized-fetch 2>&1 | tee /tmp/repo_sync.log; then
            echo "repo sync succeeded on attempt ${attempt}"
            break
          fi

          if [ "${attempt}" -eq 3 ]; then
            echo "ERROR: repo sync failed after 3 attempts"
            echo "=== Last sync log (tail) ==="
            tail -100 /tmp/repo_sync.log || true
            echo "=== Disk space at failure ==="
            df -h
            exit 1
          fi

          echo "repo sync failed on attempt ${attempt}, cleaning up before retry..."
          # Clean partial objects and garbage to free space before retry
          rm -f .repo/.repo_trace 2>/dev/null || true
          find .repo -name "*.lock" -delete 2>/dev/null || true
          repo forall -c 'git clean -fdx' 2>/dev/null || true
          repo forall -c 'git gc --aggressive --prune=now' 2>/dev/null || true
          echo "Disk space after cleanup:"
          df -h /home/runner/workspace
          echo "Retrying in 30 seconds..."
          sleep 30
        done

    - name: Check disk space
      run: |
        echo "=== Disk space before build ==="
        df -h /
        df -h /home/runner/workspace || true
        echo "=== Workspace directory size ==="
        du -sh /home/runner/workspace/coinos/.repo || true
        du -sh /home/runner/workspace/coinos || true

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-coinos-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-coinos-ccache-

    - name: Build ROM
      shell: bash
      run: |
        cd /home/runner/workspace/coinos

        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          make clean
        fi

        source build/envsetup.sh
        lunch coin_j7xelte-userdebug

        # Set ccache directory explicitly
        export CCACHE_DIR=~/.ccache
        ccache -M 50G
        ccache -z

        # Limit jobs based on available RAM (approx 2GB per job)
        MEM_GB=$(awk '/MemTotal/ {printf "%d", $2/1024/1024}' /proc/meminfo)
        MAX_JOBS=$((MEM_GB < 1 ? 1 : MEM_GB / 2))
        NPROC=$(nproc --all)
        JOBS=$((MAX_JOBS < NPROC ? MAX_JOBS : NPROC))
        echo "Building with -j${JOBS} (RAM: ${MEM_GB}GB, CPUs: ${NPROC})"

        # Start the build
        mka bacon -j${JOBS}

    - name: Print ccache stats
      if: always()
      run: ccache -s || true

    - name: Upload Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: CoinOS-j7xelte-ROM
        path: /home/runner/workspace/coinos/out/target/product/j7xelte/CoinOS*.zip
        if-no-files-found: error
        retention-days: 7

    - name: Upload Build Logs on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          /home/runner/workspace/coinos/out/build_*.log
          /home/runner/workspace/coinos/out/verbose.log.gz
          /home/runner/workspace/coinos/out/error.log
          /tmp/repo_sync.log
        if-no-files-found: ignore
        retention-days: 7
